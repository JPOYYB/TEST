<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Pintxos Tower</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/poly-decomp@0.3.0/build/decomp.min.js"></script>
  <script src="./shape-extract.js"></script>

  <style>
    body { margin: 0; padding: 0; overflow: hidden; background-color: #f0f0f0; font-family: sans-serif; touch-action: none; }
    canvas { display: block; position: fixed; top: 0; left: 0; z-index: 0; }
    #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
    #score-board { position: absolute; top: 20px; left: 20px; font-size: 24px; font-weight: bold; color: #333; text-shadow: 2px 2px 0px white; }
    #controls { position: absolute; bottom: 30px; left: 0; width: 100%; height: 90px; display: flex; justify-content: center; align-items: center; gap: 20px; pointer-events: auto; }
    .control-btn { width: 60px; height: 60px; background: rgba(255,255,255,0.9); border: 2px solid #888; border-radius: 50%; font-size: 24px; cursor: pointer; display: flex; justify-content: center; align-items: center; box-shadow: 0 4px 5px rgba(0,0,0,0.2); user-select: none; -webkit-user-select: none; }
    .control-btn:active { background: #ccc; transform: translateY(2px); }
    #btn-drop { width: 80px; height: 80px; background: #ff4757; color: white; border: none; font-size: 32px; }
    .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 20; pointer-events: auto; }
    .hidden { display: none !important; }
    button.primary-btn { padding: 15px 40px; font-size: 18px; background: #2ecc71; color: white; border: none; border-radius: 30px; margin-top: 15px; cursor: pointer; }
    #ranking-list { padding: 0; list-style: none; margin-top:10px; }
    #ranking-list li { margin: 5px 0; border-bottom: 1px solid #ddd; padding: 5px; width: 220px; display:flex; justify-content:space-between; }
  </style>
</head>
<body>

  <div id="ui-layer">
    <div id="score-board">SCORE: <span id="score-val">0</span></div>
    <div id="controls" class="hidden">
      <button class="control-btn" id="btn-left">‚¨ÖÔ∏è</button>
      <button class="control-btn" id="btn-rotate">üîÑ</button>
      <button class="control-btn" id="btn-right">‚û°Ô∏è</button>
      <button class="control-btn" id="btn-drop">‚¨áÔ∏è</button>
    </div>
  </div>

  <div id="title-screen" class="overlay">
    <h1>Pintxos Tower</h1>
    <p>ÁîªÂÉè„ÇíÁ©ç„Åø‰∏ä„Åí„ÇçÔºÅ</p>
    <button class="primary-btn" onclick="startGame()">START</button>
  </div>

  <div id="game-over-screen" class="overlay hidden">
    <h1>GAME OVER</h1>
    <p>Score: <span id="final-score">0</span></p>
    <div id="input-area">
      <input type="text" id="player-name" placeholder="ÂêçÂâç„ÇíÂÖ•Âäõ" maxlength="8" style="padding:10px; font-size:16px; text-align:center;">
      <br>
      <button class="primary-btn" onclick="saveScore()">„É©„É≥„Ç≠„É≥„Ç∞ÁôªÈå≤</button>
      <br>
      <button style="margin-top:15px; background:none; border:none; text-decoration:underline; color:#666;" onclick="resetGame()">„É™„Éà„É©„Ç§</button>
    </div>
    <div id="ranking-area" class="hidden">
      <h3>„É©„É≥„Ç≠„É≥„Ç∞</h3>
      <ul id="ranking-list"></ul>
      <button class="primary-btn" onclick="resetGame()">„ÇÇ„ÅÜ‰∏ÄÂ∫¶</button>
    </div>
  </div>

<script>
  window.decomp = decomp;
  Matter.Common.setDecomp(decomp);

  const Engine = Matter.Engine,
        Render = Matter.Render,
        Runner = Matter.Runner,
        Bodies = Matter.Bodies,
        Composite = Matter.Composite,
        Events = Matter.Events,
        Body = Matter.Body;

  let engine, render, runner;
  let ground;
  let currentPintxo = null;
  let isDropping = false;
  let gameActive = false;
  let score = 0;

  const IMAGES = [];
  for (let i = 1; i <= 11; i++) IMAGES.push(`./img/${i}.png`);

  let w = window.innerWidth;
  let h = window.innerHeight;

  // ===== „Åì„Åì„Å†„Åë„ÅßË™øÊï¥„Åß„Åç„Çã„Çà„ÅÜ„Å´ÈõÜÁ¥Ñ =====
  const CFG = {
    targetSize: 125,     // Ë¶ã„ÅüÁõÆ„Çµ„Ç§„Ç∫Áµ±‰∏Ä
    hitInset: 0.95,      // Á©∫‰∏≠„Éí„ÉÉ„Éà„ÅåÊÆã„Çã„Å™„Çâ 0.90 / „Åô„ÇäÊäú„Åë„Çã„Å™„Çâ 0.98
    shape: {
      threshold: 25,     // ËñÑ„ÅÑ„Éë„Éº„ÉÑ„ÅåÊ∂à„Åà„Çã‚Üí‰∏ã„Åí„Çã(25‚Üí15) / ÈÄèÊòéÁ∏ÅÊãæ„ÅÜ‚Üí‰∏ä„Åí„Çã(25‚Üí40)
      sampleScale: 0.35, // Á≤æÂ∫¶UP: 0.45ÔºàÈáç„Åè„Å™„ÇãÔºâ
      nPoints: 160       // ÂΩ¢„ÅÆÁ≤æÂØÜ„Åï: 200ÔºàÈáç„Åè„Å™„ÇãÔºâ
    },
    dropDelayMs: 800
  };

  window.onload = () => init();

  function init() {
    engine = Engine.create();
    engine.world.gravity.y = 1;

    render = Render.create({
      element: document.body,
      engine: engine,
      options: {
        width: w,
        height: h,
        background: '#f0f0f0',
        wireframes: false,
        pixelRatio: 1
      }
    });

    createGround();

    Render.run(render);
    runner = Runner.create();
    Runner.run(runner, engine);

    Events.on(engine, 'beforeUpdate', updateLoop);

    window.addEventListener('resize', () => {
      w = window.innerWidth; h = window.innerHeight;
      render.canvas.width = w; render.canvas.height = h;
      createGround();
    });
  }

  function createGround() {
    if (ground) Composite.remove(engine.world, ground);

    const groundY = h - 180;
    const groundWidth = w * 0.3;

    ground = Bodies.rectangle(w / 2, groundY, groundWidth, 20, {
      isStatic: true,
      label: 'Ground',
      render: { fillStyle: '#8b4513' },
      friction: 1.0
    });

    Composite.add(engine.world, ground);
  }

  function startGame() {
    document.getElementById('title-screen').classList.add('hidden');
    document.getElementById('game-over-screen').classList.add('hidden');
    document.getElementById('controls').classList.remove('hidden');

    Composite.clear(engine.world, false);
    createGround();

    Render.lookAt(render, { min: { x: 0, y: 0 }, max: { x: w, y: h } });

    score = 0;
    document.getElementById('score-val').innerText = score;

    isDropping = false;
    gameActive = true;

    spawnPintxo();
  }

  async function spawnPintxo() {
    if (!gameActive) return;

    const imgPath = IMAGES[Math.floor(Math.random() * IMAGES.length)];
    const spawnX = w / 2;
    const spawnY = render.bounds.min.y + 100;

    const body = await ShapeExtract.makeBody(imgPath, spawnX, spawnY, {
      targetSize: CFG.targetSize,
      hitInset: CFG.hitInset,
      shapeCfg: CFG.shape,
      bodyOpts: { friction: 0.8, restitution: 0.1 }
    });

    currentPintxo = body;
    Body.setStatic(currentPintxo, true);
    currentPintxo.isDropped = false;
    Composite.add(engine.world, currentPintxo);
    isDropping = false;
  }

  function updateLoop() {
    if (!gameActive) return;

    const allBodies = Composite.allBodies(engine.world);

    // „Ç´„É°„É©ËøΩÂæì
    let highestY = ground.position.y;
    let hasStack = false;

    for (const b of allBodies) {
      if (b.label === 'Pintxo' && b !== currentPintxo) {
        if (b.position.y < highestY) { highestY = b.position.y; hasStack = true; }
      }
    }

    let targetTopY = 0;
    if (hasStack) targetTopY = highestY - (h * 0.5);
    if (targetTopY > 0) targetTopY = 0;

    const currentTopY = render.bounds.min.y;
    if (targetTopY < currentTopY) {
      const newY = currentTopY + (targetTopY - currentTopY) * 0.05;
      Render.lookAt(render, { min: { x: 0, y: newY }, max: { x: w, y: newY + h } });
    } else if (currentTopY < 0 && !hasStack) {
      Render.lookAt(render, { min: { x: 0, y: 0 }, max: { x: w, y: h } });
    }

    // ‰∏ã„Å´Ê∂à„Åà„Åü„Çâ„Éü„Çπ
    const deadLine = render.bounds.max.y + 200;
    for (const b of allBodies) {
      if (b.label === 'Pintxo' && b !== currentPintxo) {
        if (b.position.y > deadLine) { gameOver(); break; }
      }
    }
  }

  function move(dir) {
    if (currentPintxo && !isDropping) Body.translate(currentPintxo, { x: dir * 6, y: 0 });
  }

  function rotate() {
    if (currentPintxo && !isDropping) Body.rotate(currentPintxo, Math.PI / 4);
  }

  function drop() {
    if (currentPintxo && !isDropping) {
      isDropping = true;
      Body.setStatic(currentPintxo, false);
      currentPintxo.isDropped = true;

      setTimeout(() => {
        if (!gameActive) return;
        calcScore(currentPintxo);
        spawnPintxo();
      }, CFG.dropDelayMs);
    }
  }

  function calcScore(body) {
    const diff = ground.position.y - body.position.y;
    if (diff > 0) {
      score += (Math.floor(diff / 10) + 10);
      document.getElementById('score-val').innerText = score;
    }
  }

  function gameOver() {
    if (!gameActive) return;
    gameActive = false;

    document.getElementById('final-score').innerText = score;
    document.getElementById('controls').classList.add('hidden');
    document.getElementById('game-over-screen').classList.remove('hidden');
    document.getElementById('input-area').classList.remove('hidden');
    document.getElementById('ranking-area').classList.add('hidden');
  }

  window.saveScore = function () {
    const name = document.getElementById('player-name').value || "ÂêçÁÑ°„Åó";
    const data = JSON.parse(localStorage.getItem('pintxosRank')) || [];
    data.push({ name, score });
    data.sort((a, b) => b.score - a.score);
    localStorage.setItem('pintxosRank', JSON.stringify(data.slice(0, 5)));
    showRank();
  };

  function showRank() {
    const data = JSON.parse(localStorage.getItem('pintxosRank')) || [];
    const list = document.getElementById('ranking-list');
    list.innerHTML = "";
    data.forEach((d, i) => list.innerHTML += `<li><span>${i + 1}.${d.name}</span><span>${d.score}</span></li>`);
    document.getElementById('input-area').classList.add('hidden');
    document.getElementById('ranking-area').classList.remove('hidden');
  }

  window.resetGame = () => startGame();

  // Controls
  const btnL = document.getElementById('btn-left');
  const btnR = document.getElementById('btn-right');
  const btnRot = document.getElementById('btn-rotate');
  const btnDrop = document.getElementById('btn-drop');

  const hold = (btn, action) => {
    let t;
    const s = (e) => { e.preventDefault(); action(); t = setInterval(action, 50); };
    const e2 = (e) => { e.preventDefault(); clearInterval(t); };
    btn.addEventListener('touchstart', s, { passive: false });
    btn.addEventListener('touchend', e2);
    btn.addEventListener('touchcancel', e2);
    btn.addEventListener('mousedown', s);
    btn.addEventListener('mouseup', e2);
    btn.addEventListener('mouseleave', e2);
  };

  hold(btnL, () => move(-1));
  hold(btnR, () => move(1));
  btnRot.addEventListener('click', rotate);
  btnRot.addEventListener('touchstart', (e) => { e.preventDefault(); rotate(); }, { passive: false });
  btnDrop.addEventListener('click', drop);
  btnDrop.addEventListener('touchstart', (e) => { e.preventDefault(); drop(); }, { passive: false });
</script>
</body>
</html>

