<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pintxos Tower</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        /* åŸºæœ¬è¨­å®š */
        body { 
            margin: 0; padding: 0; overflow: hidden; 
            background-color: #f0f0f0; 
            font-family: sans-serif; 
            touch-action: none; 
            width: 100%; height: 100%;
        }

        /* ã‚²ãƒ¼ãƒ é ˜åŸŸ */
        #game-container {
            position: absolute; top: 0; left: 0;
            width: 100vw; height: 100vh;
            z-index: 1;
        }

        /* UIãƒ¬ã‚¤ãƒ¤ãƒ¼ */
        #ui-layer {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        /* ã‚¹ã‚³ã‚¢ */
        #score-board {
            position: absolute; top: 20px; left: 20px;
            font-size: 24px; font-weight: bold; color: #333;
            text-shadow: 2px 2px 0px white;
        }

        /* æ“ä½œãƒœã‚¿ãƒ³ç¾¤ï¼ˆç”»é¢ä¸‹ã«å›ºå®šï¼‰ */
        #controls {
            position: absolute; bottom: 20px; left: 0;
            width: 100%; height: 100px;
            display: flex; justify-content: center; align-items: center; gap: 15px;
            pointer-events: auto;
        }

        .control-btn {
            width: 60px; height: 60px;
            background: rgba(255,255,255,0.9);
            border: 2px solid #ccc; border-radius: 50%;
            font-size: 24px; cursor: pointer;
            display: flex; justify-content: center; align-items: center;
            user-select: none; -webkit-user-select: none;
            box-shadow: 0 4px 5px rgba(0,0,0,0.2);
        }
        .control-btn:active { background: #ddd; transform: translateY(2px); }

        #btn-drop {
            width: 80px; height: 80px;
            background: #ff4757; color: white; border: none;
            font-size: 30px;
        }

        /* ç”»é¢ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ãƒ»ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ï¼‰ */
        .overlay {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(255,255,255,0.95);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 20;
            pointer-events: auto;
        }
        
        .hidden { display: none !important; }

        h1 { margin-bottom: 20px; color: #333; }
        input { padding: 10px; font-size: 16px; margin: 10px 0; text-align: center; }
        
        button.primary-btn {
            padding: 15px 40px; font-size: 18px;
            background: #2ecc71; color: white;
            border: none; border-radius: 30px;
            cursor: pointer; margin-top: 10px;
            box-shadow: 0 4px 0 #27ae60;
        }
        button.primary-btn:active { transform: translateY(4px); box-shadow: none; }

        /* ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º */
        #ranking-list { list-style: none; padding: 0; width: 80%; max-width: 300px; }
        #ranking-list li { border-bottom: 1px solid #ccc; padding: 8px; display: flex; justify-content: space-between; }
    </style>
</head>
<body>

    <div id="game-container"></div>

    <div id="ui-layer">
        <div id="score-board">SCORE: <span id="score-val">0</span></div>
        
        <div id="controls" class="hidden">
            <button class="control-btn" id="btn-left">â¬…ï¸</button>
            <button class="control-btn" id="btn-rotate">ğŸ”„</button>
            <button class="control-btn" id="btn-right">â¡ï¸</button>
            <button class="control-btn" id="btn-drop">â¬‡ï¸</button>
        </div>
    </div>

    <div id="title-screen" class="overlay">
        <h1>Pintxos Tower</h1>
        <p>ãƒ”ãƒ³ãƒãƒ§ã‚¹ã‚’ç©ã¿ä¸Šã’ã‚ï¼</p>
        <button class="primary-btn" onclick="startGame()">START GAME</button>
    </div>

    <div id="game-over-screen" class="overlay hidden">
        <h1>GAME OVER</h1>
        <p>Score: <span id="final-score">0</span></p>
        
        <div id="input-area">
            <input type="text" id="player-name" placeholder="åå‰ã‚’å…¥åŠ›" maxlength="8">
            <br>
            <button class="primary-btn" onclick="saveScore()">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç™»éŒ²</button>
            <br>
            <button style="margin-top:15px; background:none; border:none; color:#666; text-decoration:underline;" onclick="resetGame()">ç™»éŒ²ã›ãšã«ãƒªãƒˆãƒ©ã‚¤</button>
        </div>

        <div id="ranking-area" class="hidden">
            <h3>ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
            <ul id="ranking-list"></ul>
            <button class="primary-btn" onclick="resetGame()">ã‚‚ã†ä¸€åº¦éŠã¶</button>
        </div>
    </div>

<script>
    // --- Matter.js ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹ ---
    const Engine = Matter.Engine,
          Render = Matter.Render,
          Runner = Matter.Runner,
          Bodies = Matter.Bodies,
          Composite = Matter.Composite,
          Events = Matter.Events,
          Body = Matter.Body;

    // å¤‰æ•°å®šç¾©
    let engine, render, runner;
    let ground;
    let currentPintxo = null;
    let isDropping = false;
    let gameActive = false;
    let score = 0;
    
    // ç”»åƒãƒªã‚¹ãƒˆ (imgãƒ•ã‚©ãƒ«ãƒ€ã® 1.png ï½ 11.png)
    const IMAGE_COUNT = 11;
    const IMAGES = [];
    for(let i=1; i<=IMAGE_COUNT; i++) IMAGES.push(`./img/${i}.png`);

    // ç”»é¢ã‚µã‚¤ã‚º
    let width = window.innerWidth;
    let height = window.innerHeight;

    // --- åˆæœŸåŒ–å‡¦ç† (ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚) ---
    window.onload = function() {
        initGameEngine();
        // æœ€åˆã®çŠ¶æ…‹ã§ã¯ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹
    };

    function initGameEngine() {
        // ã‚¨ãƒ³ã‚¸ãƒ³ä½œæˆ
        engine = Engine.create();
        
        // ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ä½œæˆ
        const container = document.getElementById('game-container');
        render = Render.create({
            element: container,
            engine: engine,
            options: {
                width: width,
                height: height,
                background: '#f0f0f0',
                wireframes: false, // â˜…ç”»åƒè¡¨ç¤ºã«å¿…é ˆ
                hasBounds: true
            }
        });

        // æç”»é–‹å§‹
        Render.run(render);
        
        // ç‰©ç†æ¼”ç®—ãƒ«ãƒ¼ãƒ—é–‹å§‹
        runner = Runner.create();
        Runner.run(runner, engine);

        // ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆæ›´æ–°ã”ã¨ã®å‡¦ç†ï¼‰
        Events.on(engine, 'beforeUpdate', updateGameLoop);

        // ãƒªã‚µã‚¤ã‚ºå¯¾å¿œ
        window.addEventListener('resize', () => {
            width = window.innerWidth;
            height = window.innerHeight;
            render.canvas.width = width;
            render.canvas.height = height;
        });

        // ã‚¹ã‚¿ãƒ¼ãƒˆå‰ã®æ¼”å‡ºã¨ã—ã¦ã€ã¨ã‚Šã‚ãˆãšçš¿ã ã‘ç½®ã„ã¦ãŠã
        createGround();
    }

    // --- çš¿ï¼ˆåºŠï¼‰ã®ä½œæˆ ---
    function createGround() {
        // æ—¢å­˜ã®çš¿ãŒã‚ã‚Œã°æ¶ˆã™ï¼ˆé‡è¤‡é˜²æ­¢ï¼‰
        if(ground) Composite.remove(engine.world, ground);

        // ç”»é¢ä¸‹éƒ¨ã«é…ç½®
        const groundY = height - 30; 
        ground = Bodies.rectangle(width / 2, groundY, 320, 30, { 
            isStatic: true,
            label: 'Ground',
            render: {
                fillStyle: '#8b4513',
                strokeStyle: '#5e2f0d',
                lineWidth: 2
            }
        });
        Composite.add(engine.world, ground);
    }

    // --- ã‚²ãƒ¼ãƒ é–‹å§‹å‡¦ç† ---
    window.startGame = function() {
        // 1. ä¸–ç•Œã‚’ã‚¯ãƒªã‚¢ï¼ˆå…¨ã¦ã®ç‰©ä½“ã‚’æ¶ˆå»ï¼‰
        Composite.clear(engine.world);
        Engine.clear(engine);

        // 2. çš¿ã‚’å†ä½œæˆï¼ˆã“ã‚ŒãŒæ¶ˆãˆã¦ã„ãŸåŸå› ã®å¯¾ç­–ï¼‰
        createGround();

        // 3. ã‚«ãƒ¡ãƒ©è¦–ç‚¹ã‚’åˆæœŸä½ç½®ã«ãƒªã‚»ãƒƒãƒˆ
        Render.lookAt(render, {
            min: { x: 0, y: 0 },
            max: { x: width, y: height }
        });

        // 4. UIåˆ‡ã‚Šæ›¿ãˆ
        document.getElementById('title-screen').classList.add('hidden');
        document.getElementById('game-over-screen').classList.add('hidden');
        document.getElementById('controls').classList.remove('hidden');

        // 5. å¤‰æ•°ãƒªã‚»ãƒƒãƒˆ
        score = 0;
        updateScoreDisplay();
        gameActive = true;
        currentPintxo = null;
        isDropping = false;

        // 6. æœ€åˆã®ãƒ”ãƒ³ãƒãƒ§ã‚¹ç”Ÿæˆ
        spawnPintxo();
    };

    // --- ãƒ”ãƒ³ãƒãƒ§ã‚¹ç”Ÿæˆ ---
    function spawnPintxo() {
        if (!gameActive) return;

        // ãƒ©ãƒ³ãƒ€ãƒ é¸æŠ
        const idx = Math.floor(Math.random() * IMAGES.length);
        const imgPath = IMAGES[idx];
        
        // å¿µã®ãŸã‚ãƒ©ãƒ³ãƒ€ãƒ ãªè‰²ã‚‚æ±ºã‚ã¦ãŠãï¼ˆç”»åƒãŒå‡ºãªã„æ™‚ç”¨ï¼‰
        const randomColor = '#' + Math.floor(Math.random()*16777215).toString(16);

        // å‡ºç¾ä½ç½®ï¼ˆã‚«ãƒ¡ãƒ©ã®ä¸Šéƒ¨ï¼‰
        // render.bounds.min.y ã¯ç¾åœ¨ã®ã‚«ãƒ¡ãƒ©ã®ä¸€ç•ªä¸Šã®Yåº§æ¨™
        const spawnX = width / 2;
        const spawnY = render.bounds.min.y + 100; 

        // ãƒ”ãƒ³ãƒãƒ§ã‚¹ä½œæˆï¼ˆå††å½¢åˆ¤å®šï¼‰
        currentPintxo = Bodies.circle(spawnX, spawnY, 40, {
            label: 'Pintxo',
            restitution: 0.1, // è·³ã­è¿”ã‚Š
            friction: 0.6,    // æ‘©æ“¦
            density: 0.002,
            render: {
                fillStyle: randomColor, // â˜…ç”»åƒãŒãªã„æ™‚ã¯ã“ã®è‰²ãŒã§ã‚‹
                sprite: {
                    texture: imgPath,
                    xScale: 0.8, // ç”»åƒã‚µã‚¤ã‚ºèª¿æ•´ (100px -> 80px)
                    yScale: 0.8
                }
            }
        });

        // æ“ä½œä¸­ã¯å›ºå®š(Static)
        Body.setStatic(currentPintxo, true);
        currentPintxo.isDropped = false;

        Composite.add(engine.world, currentPintxo);
        isDropping = false;
    }

    // --- ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—ï¼ˆå¸¸æ™‚ç›£è¦–ï¼‰ ---
    function updateGameLoop() {
        if (!gameActive) return;

        // 1. ã‚«ãƒ¡ãƒ©è¿½å¾“ï¼ˆç©ã¿ä¸ŠãŒã£ãŸã‚‰è¦–ç‚¹ã‚’ä¸Šã’ã‚‹ï¼‰
        if (currentPintxo && !currentPintxo.isStatic) {
            // è½ä¸‹ä¸­ã¯å‹•ã‹ã•ãªã„
        } else {
            // ä¸€ç•ªé«˜ã„ç‰©ä½“ã‚’æ¢ã™
            let allBodies = Composite.allBodies(engine.world);
            let highestY = ground.position.y;
            
            allBodies.forEach(b => {
                // ãƒ”ãƒ³ãƒãƒ§ã‚¹ã‹ã¤ã€ã¾ã æœ‰åŠ¹ãªã‚‚ã®
                if (b.label === 'Pintxo' && b.position.y < highestY) {
                    highestY = b.position.y;
                }
            });

            // ç›®æ¨™ã‚«ãƒ¡ãƒ©ä½ç½®
            const targetTopY = highestY - 300; // ä¸€ç•ªä¸Šã®ç‰©ä½“ã‹ã‚‰300pxä¸Šã‚’ç”»é¢ä¸Šç«¯ã«ã™ã‚‹
            const currentTopY = render.bounds.min.y;

            // ã‚¹ãƒ ãƒ¼ã‚ºã«ç§»å‹•ï¼ˆç›®æ¨™ãŒç¾åœ¨ã‚ˆã‚Šä¸Šï¼YãŒå°ã•ã„å ´åˆï¼‰
            if (targetTopY < currentTopY) {
                const newMinY = currentTopY + (targetTopY - currentTopY) * 0.05;
                Render.lookAt(render, {
                    min: { x: 0, y: newMinY },
                    max: { x: width, y: newMinY + height }
                });
            }
        }

        // 2. ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼åˆ¤å®šï¼ˆç”»é¢å¤–ã¸è½ä¸‹ï¼‰
        let bodies = Composite.allBodies(engine.world);
        const deadLine = ground.position.y + 150; // çš¿ã‚ˆã‚Š150pxä¸‹

        bodies.forEach(b => {
            if (b.label === 'Pintxo') {
                // ã¾ã æ“ä½œä¸­ã®ã‚„ã¤ã¯é™¤å¤–
                if (b === currentPintxo && !b.isDropped) return;

                if (b.position.y > deadLine) {
                    endGame();
                }
            }
        });
    }

    // --- æ“ä½œé–¢æ•° ---
    function movePintxo(dx) {
        if (currentPintxo && !isDropping) {
            Body.translate(currentPintxo, { x: dx, y: 0 });
        }
    }
    
    function rotatePintxo() {
        if (currentPintxo && !isDropping) {
            Body.rotate(currentPintxo, Math.PI / 4); // 45åº¦
        }
    }

    function dropPintxo() {
        if (currentPintxo && !isDropping) {
            isDropping = true;
            Body.setStatic(currentPintxo, false); // ç‰©ç†æ¼”ç®—ON
            currentPintxo.isDropped = true;

            // æ¬¡ã®ç”Ÿæˆäºˆç´„
            setTimeout(() => {
                if (gameActive) {
                    calcScore(currentPintxo);
                    spawnPintxo();
                }
            }, 2000); // 2ç§’å¾Œã«æ¬¡
        }
    }

    // --- ã‚¹ã‚³ã‚¢è¨ˆç®— ---
    function calcScore(body) {
        // é«˜ã•ãƒœãƒ¼ãƒŠã‚¹
        const heightDiff = (ground.position.y - body.position.y);
        // çš¿ã‚ˆã‚Šä¸Šãªã‚‰åŠ ç®—
        if (heightDiff > 0) {
            const pts = Math.floor(heightDiff / 5) + 10;
            score += pts;
            updateScoreDisplay();
        }
    }

    function updateScoreDisplay() {
        document.getElementById('score-val').innerText = score;
    }

    // --- ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼å‡¦ç† ---
    function endGame() {
        if (!gameActive) return;
        gameActive = false;
        
        document.getElementById('final-score').innerText = score;
        document.getElementById('controls').classList.add('hidden');
        document.getElementById('game-over-screen').classList.remove('hidden');
        document.getElementById('input-area').classList.remove('hidden');
        document.getElementById('ranking-area').classList.add('hidden');
    }

    // --- ãƒ©ãƒ³ã‚­ãƒ³ã‚°ä¿å­˜ ---
    window.saveScore = function() {
        const name = document.getElementById('player-name').value || "åç„¡ã—";
        const record = { name, score, date: new Date().toLocaleDateString() };
        
        let rankings = JSON.parse(localStorage.getItem('pintxosRanking')) || [];
        rankings.push(record);
        rankings.sort((a,b) => b.score - a.score);
        rankings = rankings.slice(0, 5);
        
        localStorage.setItem('pintxosRanking', JSON.stringify(rankings));
        showRanking();
    };

    window.showRanking = function() {
        document.getElementById('input-area').classList.add('hidden');
        document.getElementById('ranking-area').classList.remove('hidden');
        const list = document.getElementById('ranking-list');
        list.innerHTML = "";
        
        const rankings = JSON.parse(localStorage.getItem('pintxosRanking')) || [];
        rankings.forEach((r, i) => {
            list.innerHTML += `<li><span>${i+1}. ${r.name}</span> <span>${r.score}pt</span></li>`;
        });
    };

    window.resetGame = function() {
        startGame();
    };

    // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š ---
    const btnLeft = document.getElementById('btn-left');
    const btnRight = document.getElementById('btn-right');
    const btnRotate = document.getElementById('btn-rotate');
    const btnDrop = document.getElementById('btn-drop');

    // é•·æŠ¼ã—å¯¾å¿œ
    const attachHold = (btn, action) => {
        let timer;
        const start = (e) => { e.preventDefault(); action(); timer = setInterval(action, 50); };
        const end = (e) => { e.preventDefault(); clearInterval(timer); };
        btn.addEventListener('mousedown', start);
        btn.addEventListener('touchstart', start, {passive:false});
        btn.addEventListener('mouseup', end);
        btn.addEventListener('touchend', end, {passive:false});
    };

    attachHold(btnLeft, () => movePintxo(-5));
    attachHold(btnRight, () => movePintxo(5));

    // ã‚¯ãƒªãƒƒã‚¯å¯¾å¿œ
    const attachClick = (btn, action) => {
        btn.addEventListener('click', action);
        btn.addEventListener('touchstart', (e) => { e.preventDefault(); action(); }, {passive:false});
    };
    attachClick(btnRotate, rotatePintxo);
    attachClick(btnDrop, dropPintxo);

</script>
</body>
</html>
