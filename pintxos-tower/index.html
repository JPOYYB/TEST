<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pintxos Tower</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; background-color: #f0f0f0; font-family: 'Helvetica', sans-serif; touch-action: none; }
        #game-container { position: relative; width: 100vw; height: 100vh; }
        canvas { display: block; width: 100%; height: 100%; }
        
        /* UI Overlay */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; }
        
        /* Title Screen */
        #title-screen, #game-over-screen { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(255, 255, 255, 0.9); display: flex; flex-direction: column; 
            align-items: center; justify-content: center; pointer-events: auto; z-index: 10;
        }
        h1 { margin: 0 0 20px 0; color: #333; font-size: 2em; }
        button.btn { padding: 15px 40px; font-size: 1.2em; background: #ff6b6b; color: white; border: none; border-radius: 30px; cursor: pointer; box-shadow: 0 4px 0 #d45050; }
        button.btn:active { transform: translateY(4px); box-shadow: none; }

        /* HUD */
        #score-board { padding: 20px; font-size: 1.5em; color: #333; font-weight: bold; text-shadow: 1px 1px 0 #fff; }
        
        /* Controls */
        #controls { pointer-events: auto; display: none; padding-bottom: 30px; width: 100%; justify-content: center; gap: 10px; }
        .control-btn { 
            width: 70px; height: 70px; border-radius: 50%; border: none; 
            background: rgba(255, 255, 255, 0.8); font-size: 24px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); touch-action: manipulation;
        }
        .control-btn:active { background: #ddd; }
        #btn-drop { background: #ff6b6b; color: white; width: 90px; height: 90px; font-weight: bold;}

        /* Ranking */
        #ranking-list { list-style: none; padding: 0; text-align: center; width: 80%; max-width: 300px; }
        #ranking-list li { border-bottom: 1px solid #ccc; padding: 5px; display: flex; justify-content: space-between; }
        input#player-name { padding: 10px; font-size: 1em; border: 1px solid #ccc; border-radius: 5px; margin-bottom: 10px; width: 70%; }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="game-container">
    <div id="ui-layer">
        <div id="score-board">SCORE: <span id="score-val">0</span></div>
        <div id="controls">
            <button class="control-btn" id="btn-left">‚¨ÖÔ∏è</button>
            <button class="control-btn" id="btn-rotate">üîÑ</button>
            <button class="control-btn" id="btn-right">‚û°Ô∏è</button>
            <button class="control-btn" id="btn-drop">‚¨áÔ∏è</button>
        </div>
    </div>

    <div id="title-screen">
        <h1>Pintxos Tower</h1>
        <p>„Éî„É≥„ÉÅ„Éß„Çπ„ÇíÁ©ç„Åø‰∏ä„Åí„ÇçÔºÅ</p>
        <button class="btn" onclick="startGame()">START</button>
    </div>

    <div id="game-over-screen" class="hidden">
        <h1>GAME OVER</h1>
        <p>Score: <span id="final-score">0</span></p>
        
        <div id="input-area">
            <input type="text" id="player-name" placeholder="ÂêçÂâç„ÇíÂÖ•Âäõ" maxlength="8">
            <button class="btn" style="padding: 10px 20px; font-size: 1em;" onclick="saveScore()">„É©„É≥„Ç≠„É≥„Ç∞ÁôªÈå≤</button>
        </div>
        <div id="ranking-area" class="hidden">
            <h3>Top 5 Ranking</h3>
            <ul id="ranking-list"></ul>
            <button class="btn" style="margin-top:20px;" onclick="resetGame()">RETRY</button>
        </div>
    </div>
</div>

<script>
    // --- ÂàùÊúüË®≠ÂÆö ---
    const Engine = Matter.Engine,
          Render = Matter.Render,
          Runner = Matter.Runner,
          Bodies = Matter.Bodies,
          Composite = Matter.Composite,
          Events = Matter.Events,
          Body = Matter.Body;

    // ÁîªÂÉèË®≠ÂÆö
    const IMAGES = [];
    for(let i=1; i<=11; i++) IMAGES.push(`./img/${i}.png`);

    let engine, render, runner;
    let currentPintxo = null;
    let isDropping = false;
    let score = 0;
    let gameActive = false;
    let ground;

    // „Çπ„Éû„ÉõÂà§ÂÆö
    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

    function init() {
        // „Ç®„É≥„Ç∏„É≥‰ΩúÊàê
        engine = Engine.create();
        
        // „É¨„É≥„ÉÄ„É©„Éº‰ΩúÊàê
        const container = document.getElementById('game-container');
        render = Render.create({
            element: container,
            engine: engine,
            options: {
                width: container.clientWidth,
                height: container.clientHeight,
                background: '#f0f0f0',
                wireframes: false // ÁîªÂÉè„ÇíË°®Á§∫„Åô„Çã„Åü„ÇÅ„Å´false
            }
        });

        // Â∫äÔºàÁöøÔºâ„ÅÆ‰ΩúÊàê
        const groundX = container.clientWidth / 2;
        const groundY = container.clientHeight - 50;
        ground = Bodies.rectangle(groundX, groundY, 300, 20, { 
            isStatic: true,
            render: { fillStyle: '#8b4513' },
            label: 'Ground'
        });
        
        // Â£ÅÔºàÁîªÈù¢Â§ñ„Å´ËêΩ„Å°„Å™„ÅÑ„Çà„ÅÜ„Å´„Åô„Çã„Åü„ÇÅ„ÅÆ„Ç¨„Ç§„Éâ„ÄÅËêΩ‰∏ã‰∏≠„ÅØÁÑ°ÂäπÂåñ„Å™„Å©„ÅÆÂá¶ÁêÜ„ÅåÂøÖË¶Å„Å†„Åå‰ªäÂõû„ÅØ„Ç∑„É≥„Éó„É´„Å´Áöø„Åã„ÇâËêΩ„Å°„Åü„ÇâË≤†„Åë„Å´„Åô„Çã„ÅÆ„ÅßÂ£Å„ÅØ„Å™„ÅóÔºâ

        Composite.add(engine.world, ground);

        Render.run(render);
        runner = Runner.create();
        Runner.run(runner, engine);

        // Êõ¥Êñ∞„Åî„Å®„ÅÆÂá¶ÁêÜ
        Events.on(engine, 'beforeUpdate', function() {
            if (!gameActive) return;

            // „Ç´„É°„É©ÁßªÂãïÔºàÁ©ç„Åø‰∏ä„Åå„Å£„Åü„ÇâË¶ñÁÇπ„Çí‰∏ä„Åí„ÇãÔºâ
            if (currentPintxo && !currentPintxo.isStatic) {
                // ËêΩ‰∏ã‰∏≠„ÅØ„Ç´„É°„É©ËøΩÂæì„Åó„Å™„ÅÑ
            } else {
                // ÊúÄ„ÇÇÈ´ò„ÅÑ‰ΩçÁΩÆ„Å´„ÅÇ„Çã„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÇíÊé¢„Åô
                let allBodies = Composite.allBodies(engine.world);
                let highestY = ground.position.y;
                
                allBodies.forEach(b => {
                    if (b.label === 'Pintxo' && b.position.y < highestY) {
                        highestY = b.position.y;
                    }
                });

                // ÁîªÈù¢‰∏äÈÉ®200px„Çà„Çä‰∏ä„Å´Ë°å„Å£„Åü„Çâ„Ç´„É°„É©„Çí‰∏ä„Å´„Åö„Çâ„Åô
                const targetY = highestY - 200;
                const shiftY = (render.bounds.min.y - (targetY - 300)) * 0.05; // „Çπ„É†„Éº„Ç∫ÁßªÂãï
                
                if (render.bounds.min.y > targetY - 300) {
                     Render.lookAt(render, {
                        min: { x: 0, y: targetY - 300 },
                        max: { x: container.clientWidth, y: targetY - 300 + container.clientHeight }
                    });
                }
            }

            // „Ç≤„Éº„É†„Ç™„Éº„Éê„ÉºÂà§ÂÆöÔºàÁîªÈù¢‰∏ã„ÅÆ‰∏ÄÂÆö„É©„Ç§„É≥„ÇíË∂Ö„Åà„Åü„ÇâÔºâ
            let allBodies = Composite.allBodies(engine.world);
            allBodies.forEach(b => {
                if (b.label === 'Pintxo' && b.position.y > ground.position.y + 100) {
                    // Êìç‰Ωú‰∏≠„ÅÆ„Éî„É≥„ÉÅ„Éß„Çπ‰ª•Â§ñ„ÅåËêΩ„Å°„Åü„Çâ„Ç≤„Éº„É†„Ç™„Éº„Éê„Éº
                    if (b !== currentPintxo || (b === currentPintxo && b.isDropped)) {
                        gameOver();
                    }
                }
            });
        });
    }

    function startGame() {
        document.getElementById('title-screen').classList.add('hidden');
        document.getElementById('controls').style.display = 'flex';
        document.getElementById('game-over-screen').classList.add('hidden');
        
        // „É™„Çª„ÉÉ„Éà
        Composite.clear(engine.world);
        Engine.clear(engine);
        Composite.add(engine.world, ground);
        
        // „Ç´„É°„É©„É™„Çª„ÉÉ„Éà
        Render.lookAt(render, {
            min: { x: 0, y: 0 },
            max: { x: render.canvas.width, y: render.canvas.height }
        });

        score = 0;
        updateScore();
        gameActive = true;
        
        spawnPintxo();
    }

    function spawnPintxo() {
        if (!gameActive) return;

        // „É©„É≥„ÉÄ„É†„Å´ÁîªÂÉèÈÅ∏Êäû
        const imgIndex = Math.floor(Math.random() * IMAGES.length);
        const imgPath = IMAGES[imgIndex];
        
        // Âá∫Áèæ‰ΩçÁΩÆ
        const startX = render.bounds.min.x + (render.bounds.max.x - render.bounds.min.x) / 2;
        const startY = render.bounds.min.y + 100;

        // „Éî„É≥„ÉÅ„Éß„Çπ„ÅÆÁîüÊàê
        // ‚òÖÈáçË¶Å: Êú¨Ê†ºÁöÑ„Å™ÂΩ¢Áä∂Âà§ÂÆö„Å´„ÅØÈ†ÇÁÇπ„Éá„Éº„Çø„ÅåÂøÖË¶Å„Åß„Åô„Åå„ÄÅ
        // „Åì„Åì„Åß„ÅØÁîªÂÉè„ÇíÂÜÜÂΩ¢(Circle)„Åæ„Åü„ÅØÂõõËßí(Rectangle)„Å®„Åó„Å¶Âà§ÂÆö„Åï„Åõ„Åæ„Åô„ÄÇ
        // „Çø„ÉØ„Éº„Éê„Éà„É´„ÅÆ„Çà„ÅÜ„Å™Ë§áÈõë„Å™ÂΩ¢Áä∂„ÅÆÂ†¥Âêà„ÄÅÈÄöÂ∏∏„ÅØ'vertices'„Ç™„Éó„Ç∑„Éß„É≥„Çí‰Ωø„ÅÑ„Åæ„Åô„ÄÇ
        // ‰ªäÂõû„ÅØ„ÄåÂÜÜÂΩ¢„Äç„Å®„Åó„Å¶Ëøë‰ºº„Åó„Å¶„Éó„É¨„Ç§„Åó„ÇÑ„Åô„Åè„Åó„Åæ„Åô„ÄÇ
        
        currentPintxo = Bodies.circle(startX, startY, 40, { // ÂçäÂæÑ40px (100pxÁîªÂÉè„ÅÆ‰ΩôÁôΩËÄÉÊÖÆ)
            label: 'Pintxo',
            restitution: 0.1, // Ë∑≥„Å≠Ëøî„Çä‰øÇÊï∞
            friction: 0.5,    // Êë©Êì¶
            density: 0.002,   // Èáç„ÅïÔºàÂØÜÂ∫¶Ôºâ
            render: {
                sprite: {
                    texture: imgPath,
                    xScale: 0.8, // 100pxÁîªÂÉè„ÇíÂ∞ë„ÅóË™øÊï¥
                    yScale: 0.8
                }
            }
        });

        // ËêΩ‰∏ã„Åï„Åõ„Çã„Åæ„Åß„ÅØÈáçÂäõ„ÅÆÂΩ±Èüø„ÇíÂèó„Åë„Å™„ÅÑÔºàÊìç‰Ωú„É¢„Éº„ÉâÔºâ
        Body.setStatic(currentPintxo, true);
        currentPintxo.isDropped = false;

        Composite.add(engine.world, currentPintxo);
        isDropping = false;
    }

    // --- Êìç‰Ωú ---
    function moveLeft() {
        if (currentPintxo && !isDropping) {
            Body.translate(currentPintxo, { x: -10, y: 0 });
        }
    }
    function moveRight() {
        if (currentPintxo && !isDropping) {
            Body.translate(currentPintxo, { x: 10, y: 0 });
        }
    }
    function rotatePintxo() {
        if (currentPintxo && !isDropping) {
            Body.rotate(currentPintxo, Math.PI / 4); // 45Â∫¶ÂõûËª¢
        }
    }
    function dropPintxo() {
        if (currentPintxo && !isDropping) {
            isDropping = true;
            Body.setStatic(currentPintxo, false); // Áâ©ÁêÜÊºîÁÆóÈñãÂßã
            currentPintxo.isDropped = true;

            // Ê¨°„ÅÆÁîüÊàê„Åæ„Åß„ÅÆÂæÖÊ©üÂá¶ÁêÜ
            // ÈùôÊ≠¢„Åó„Åü„Åã„ÄÅ„ÅÇ„ÇãÁ®ãÂ∫¶ÊôÇÈñì„ÅåÁµå„Å£„Åü„ÇâÊ¨°„Å∏
            setTimeout(() => {
                if(gameActive) {
                    addScore(currentPintxo);
                    spawnPintxo();
                }
            }, 2000); // 2ÁßíÂæå„Å´Ê¨°„ÇíÁîüÊàêÔºàÁ∞°ÊòìÂÆüË£ÖÔºâ
        }
    }

    // „Éú„Çø„É≥„Ç§„Éô„É≥„ÉàÁ¥ê‰ªò„Åë
    const btnLeft = document.getElementById('btn-left');
    const btnRight = document.getElementById('btn-right');
    const btnRotate = document.getElementById('btn-rotate');
    const btnDrop = document.getElementById('btn-drop');

    // PC/Mobile‰∏°ÂØæÂøú„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº
    const addHoldEvent = (btn, action) => {
        let interval;
        const start = (e) => { e.preventDefault(); action(); interval = setInterval(action, 100); };
        const end = (e) => { e.preventDefault(); clearInterval(interval); };
        
        btn.addEventListener('mousedown', start);
        btn.addEventListener('touchstart', start);
        btn.addEventListener('mouseup', end);
        btn.addEventListener('touchend', end);
        btn.addEventListener('mouseleave', end);
    };

    addHoldEvent(btnLeft, moveLeft);
    addHoldEvent(btnRight, moveRight);
    
    // ÂõûËª¢„Å®ËêΩ‰∏ã„ÅØÂçòÊäº„Åó
    btnRotate.addEventListener('click', rotatePintxo);
    btnRotate.addEventListener('touchstart', (e)=>{e.preventDefault(); rotatePintxo();});
    
    btnDrop.addEventListener('click', dropPintxo);
    btnDrop.addEventListener('touchstart', (e)=>{e.preventDefault(); dropPintxo();});


    // --- „Çπ„Ç≥„Ç¢„Éª„Ç≤„Éº„É†„Ç™„Éº„Éê„Éº ---
    function addScore(body) {
        // È´ò„Åï + Èáç„Åï(Âõ∫ÂÆö)
        const heightPoint = Math.floor((ground.position.y - body.position.y) / 10);
        const weightPoint = 10; 
        score += (heightPoint + weightPoint);
        updateScore();
    }

    function updateScore() {
        document.getElementById('score-val').innerText = score;
    }

    function gameOver() {
        if (!gameActive) return;
        gameActive = false;
        
        document.getElementById('final-score').innerText = score;
        document.getElementById('game-over-screen').classList.remove('hidden');
        document.getElementById('controls').style.display = 'none';
        
        document.getElementById('input-area').classList.remove('hidden');
        document.getElementById('ranking-area').classList.add('hidden');
    }

    function resetGame() {
        startGame();
    }

    // --- „É©„É≥„Ç≠„É≥„Ç∞ÔºàLocalStorageÔºâ ---
    function saveScore() {
        const name = document.getElementById('player-name').value || "ÂêçÁÑ°„Åó";
        const newRecord = { name: name, score: score, date: new Date().toLocaleDateString() };
        
        let rankings = JSON.parse(localStorage.getItem('pintxosRanking')) || [];
        rankings.push(newRecord);
        rankings.sort((a, b) => b.score - a.score); // ÈôçÈ†Ü
        rankings = rankings.slice(0, 5); // Top 5„ÅÆ„Åø‰øùÂ≠ò
        
        localStorage.setItem('pintxosRanking', JSON.stringify(rankings));
        
        showRanking();
    }

    function showRanking() {
        document.getElementById('input-area').classList.add('hidden');
        document.getElementById('ranking-area').classList.remove('hidden');
        
        const list = document.getElementById('ranking-list');
        list.innerHTML = "";
        
        const rankings = JSON.parse(localStorage.getItem('pintxosRanking')) || [];
        rankings.forEach((r, idx) => {
            const li = document.createElement('li');
            li.innerHTML = `<span>${idx+1}. ${r.name}</span> <span>${r.score}pt</span>`;
            list.appendChild(li);
        });
    }

    // „Ç≤„Éº„É†ÂàùÊúüÂåñÂÆüË°å
    window.onload = init;

</script>
</body>
</html>