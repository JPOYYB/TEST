<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pintxos Tower</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        body { 
            margin: 0; padding: 0; overflow: hidden; 
            background-color: #f0f0f0; 
            font-family: sans-serif; 
            touch-action: none;
        }

        /* ã‚²ãƒ¼ãƒ ç”»é¢ï¼ˆä¸€ç•ªå¥¥ï¼‰ */
        canvas {
            display: block;
            width: 100%; height: 100%;
            z-index: 0;
            position: fixed; top: 0; left: 0;
        }

        /* ãƒ‡ãƒãƒƒã‚°æƒ…å ±ï¼ˆå·¦ä¸Šï¼‰ */
        #debug-info {
            position: absolute; top: 50px; left: 10px;
            font-size: 12px; color: #555;
            z-index: 100;
            background: rgba(255,255,255,0.8);
            padding: 5px;
            border-radius: 4px;
            pointer-events: none;
        }

        /* UIãƒ¬ã‚¤ãƒ¤ãƒ¼ */
        #ui-layer {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        #score-board {
            position: absolute; top: 10px; left: 10px;
            font-size: 24px; font-weight: bold; color: #333;
            text-shadow: 2px 2px 0px white;
        }

        /* æ“ä½œãƒœã‚¿ãƒ³ */
        #controls {
            position: absolute; bottom: 30px; left: 0;
            width: 100%; height: 90px;
            display: flex; justify-content: center; align-items: center; gap: 20px;
            pointer-events: auto;
        }

        .control-btn {
            width: 60px; height: 60px;
            background: rgba(255,255,255,0.95);
            border: 2px solid #888; border-radius: 50%;
            font-size: 24px; cursor: pointer;
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 4px 5px rgba(0,0,0,0.2);
            user-select: none; -webkit-user-select: none;
        }
        .control-btn:active { background: #ccc; transform: translateY(2px); }

        #btn-drop {
            width: 80px; height: 80px;
            background: #ff4757; color: white; border: none;
            font-size: 32px;
        }

        /* ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        .overlay {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(255,255,255,0.95);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            z-index: 20;
            pointer-events: auto;
        }
        .hidden { display: none !important; }
        
        button.primary-btn {
            padding: 15px 40px; font-size: 18px;
            background: #2ecc71; color: white;
            border: none; border-radius: 30px;
            margin-top: 15px; cursor: pointer;
        }
        
        #ranking-list { padding: 0; list-style: none; margin-top:10px;}
        #ranking-list li { margin: 5px 0; border-bottom: 1px solid #ddd; padding: 5px; width: 220px; display:flex; justify-content:space-between; }
    </style>
</head>
<body>

    <div id="debug-info">Initializing...</div>

    <div id="ui-layer">
        <div id="score-board">SCORE: <span id="score-val">0</span></div>
        <div id="controls" class="hidden">
            <button class="control-btn" id="btn-left">â¬…ï¸</button>
            <button class="control-btn" id="btn-rotate">ğŸ”„</button>
            <button class="control-btn" id="btn-right">â¡ï¸</button>
            <button class="control-btn" id="btn-drop">â¬‡ï¸</button>
        </div>
    </div>

    <div id="title-screen" class="overlay">
        <h1>Pintxos Tower</h1>
        <p>ãƒ”ãƒ³ãƒãƒ§ã‚¹ã‚’ç©ã¿ä¸Šã’ã‚ï¼</p>
        <button class="primary-btn" onclick="startGame()">START</button>
    </div>

    <div id="game-over-screen" class="overlay hidden">
        <h1>GAME OVER</h1>
        <p>Score: <span id="final-score">0</span></p>
        <div id="input-area">
            <input type="text" id="player-name" placeholder="åå‰ã‚’å…¥åŠ›" maxlength="8" style="padding:10px; font-size:16px; text-align:center;">
            <br>
            <button class="primary-btn" onclick="saveScore()">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç™»éŒ²</button>
            <br>
            <button style="margin-top:15px; background:none; border:none; text-decoration:underline; color:#666;" onclick="resetGame()">ãƒªãƒˆãƒ©ã‚¤</button>
        </div>
        <div id="ranking-area" class="hidden">
            <h3>ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
            <ul id="ranking-list"></ul>
            <button class="primary-btn" onclick="resetGame()">ã‚‚ã†ä¸€åº¦</button>
        </div>
    </div>

<script>
    const Engine = Matter.Engine,
          Render = Matter.Render,
          Runner = Matter.Runner,
          Bodies = Matter.Bodies,
          Composite = Matter.Composite,
          Events = Matter.Events,
          Body = Matter.Body;

    let engine, render, runner;
    let ground;
    let currentPintxo = null;
    let isDropping = false;
    let gameActive = false;
    let score = 0;
    
    // ç”»åƒå®šç¾©
    const IMAGES = [];
    for(let i=1; i<=11; i++) IMAGES.push(`./img/${i}.png`);

    // ç”»é¢ã‚µã‚¤ã‚º
    let w = window.innerWidth;
    let h = window.innerHeight;

    window.onload = function() { init(); };

    function init() {
        engine = Engine.create();
        
        // ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼è¨­å®šï¼ˆé‡è¦ï¼šãƒ”ã‚¯ã‚»ãƒ«æ¯”ç‡ã‚’1ã«å›ºå®šï¼‰
        render = Render.create({
            element: document.body,
            engine: engine,
            options: {
                width: w,
                height: h,
                background: '#f0f0f0',
                wireframes: false, // ç”»åƒãƒ¢ãƒ¼ãƒ‰
                pixelRatio: 1      // åº§æ¨™ã‚ºãƒ¬é˜²æ­¢
            }
        });

        createGround();

        Render.run(render);
        runner = Runner.create();
        Runner.run(runner, engine);

        Events.on(engine, 'beforeUpdate', updateLoop);
        
        // ãƒªã‚µã‚¤ã‚ºæ™‚ã®ã‚­ãƒ£ãƒ³ãƒã‚¹èª¿æ•´
        window.addEventListener('resize', () => {
             render.canvas.width = window.innerWidth;
             render.canvas.height = window.innerHeight;
             // çš¿ã®ä½ç½®ã‚‚ä¿®æ­£ã—ãŸã„ãŒã€è¤‡é›‘ã«ãªã‚‹ã®ã§ä»Šå›ã¯è¡¨ç¤ºé ˜åŸŸã ã‘ç¢ºä¿
        });
    }

    function createGround() {
        if(ground) Composite.remove(engine.world, ground);
        
        // ç”»é¢ä¸‹ç«¯ã‹ã‚‰30pxä¸Šã«é…ç½®
        // Yåº§æ¨™ã¯ ä¸ŠãŒ0ã€ä¸‹ãŒh
        const groundY = h - 30; 
        
        ground = Bodies.rectangle(w/2, groundY, w, 60, { 
            isStatic: true,
            label: 'Ground',
            render: { fillStyle: '#8b4513' } // èŒ¶è‰²
        });
        Composite.add(engine.world, ground);
    }

    function startGame() {
        document.getElementById('title-screen').classList.add('hidden');
        document.getElementById('game-over-screen').classList.add('hidden');
        document.getElementById('controls').classList.remove('hidden');

        Composite.clear(engine.world);
        Engine.clear(engine);

        // ç”»é¢ã‚µã‚¤ã‚ºå†å–å¾—ï¼†çš¿å†é…ç½®
        w = window.innerWidth;
        h = window.innerHeight;
        render.canvas.width = w;
        render.canvas.height = h;

        createGround();

        // ã‚«ãƒ¡ãƒ©ä½ç½®ã‚’å¼·åˆ¶çš„ã«ã€ŒåˆæœŸä½ç½®ã€ã¸æˆ»ã™
        Render.lookAt(render, {
            min: { x: 0, y: 0 },
            max: { x: w, y: h }
        });

        score = 0;
        document.getElementById('score-val').innerText = score;
        gameActive = true;
        
        spawnPintxo();
    }

    function spawnPintxo() {
        if (!gameActive) return;

        const imgIndex = Math.floor(Math.random() * IMAGES.length);
        const imgPath = IMAGES[imgIndex];
        // ãƒ©ãƒ³ãƒ€ãƒ è‰²ï¼ˆç”»åƒãŒç„¡ã„ã¨ãã®ä¿é™ºï¼‰
        const randomColor = '#' + Math.floor(Math.random()*16777215).toString(16);

        // å‡ºç¾ä½ç½®ï¼šç¾åœ¨ã®ã‚«ãƒ¡ãƒ©è¦–ç‚¹ã®ä¸Šéƒ¨(min.y) + 100px
        const spawnY = render.bounds.min.y + 100;
        const spawnX = w / 2;

        currentPintxo = Bodies.circle(spawnX, spawnY, 40, {
            label: 'Pintxo',
            restitution: 0.1,
            friction: 0.5,
            render: {
                fillStyle: randomColor, 
                sprite: {
                    texture: imgPath,
                    xScale: 0.8,
                    yScale: 0.8
                }
            }
        });

        Body.setStatic(currentPintxo, true);
        currentPintxo.isDropped = false;
        Composite.add(engine.world, currentPintxo);
        isDropping = false;
    }

    function updateLoop() {
        if (!gameActive) {
            updateDebugInfo();
            return;
        }

        // --- ã‚«ãƒ¡ãƒ©åˆ¶å¾¡ï¼ˆä¿®æ­£ç‰ˆï¼‰ ---
        
        let allBodies = Composite.allBodies(engine.world);
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯åœ°é¢ã®ä½ç½®
        let highestY = ground.position.y;
        let hasStack = false;

        // ã€Œé™æ­¢ã—ãŸãƒ”ãƒ³ãƒãƒ§ã‚¹ã€ã®ä¸­ã§ä¸€ç•ªé«˜ã„(YãŒå°ã•ã„)ã‚‚ã®ã‚’æ¢ã™
        for(let b of allBodies) {
            if(b.label === 'Pintxo' && b !== currentPintxo) { 
                // æ“ä½œä¸­ã®ãƒ”ãƒ³ãƒãƒ§ã‚¹ã¯ã‚«ãƒ¡ãƒ©è¨ˆç®—ã«å…¥ã‚Œãªã„ï¼
                if(b.position.y < highestY) {
                    highestY = b.position.y;
                    hasStack = true;
                }
            }
        }

        // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆåº§æ¨™ï¼šä¸€ç•ªä¸Šã®ç‰©ä½“ãŒã€ç”»é¢ã®ä¸Šã‹ã‚‰40%ãã‚‰ã„ã®ä½ç½®ã«æ¥ã‚‹ã‚ˆã†ã«
        let targetTopY = 0;
        
        if (hasStack) {
            targetTopY = highestY - (h * 0.4);
        } else {
            targetTopY = 0; // ã¾ã ç©ã‚“ã§ãªã„ã¨ãã¯ä¸€ç•ªä¸ŠãŒ0
        }

        // ã€é‡è¦ã€‘ã‚«ãƒ¡ãƒ©ã®ä¸‹é™åˆ¶é™
        // ã‚«ãƒ¡ãƒ©ã®ä¸‹ç«¯(targetTopY + h)ãŒã€åœ°é¢(ground.y + ä½™è£•)ã‚ˆã‚Šä¸‹ã«è¡Œã‹ãªã„ã‚ˆã†ã«ã™ã‚‹
        // ã¤ã¾ã‚Šã€targetTopY ã¯ ground.y - h ã‚ˆã‚Šå°ã•ããªã£ã¦ã¯ã„ã‘ãªã„ãŒã€
        // é€†ã« targetTopY ãŒå¤§ãããªã‚Šã™ãã‚‹ã¨åœ°é¢ãŒä¸Šã«æµ®ãã€‚
        // ã“ã“ã§ã¯ã€Œåœ°é¢ã‚ˆã‚Šä¸‹ã‚’æ˜ ã•ãªã„ã€ãŸã‚ã«ã€targetTopYã®ä¸Šé™ã‚’0ã«ã™ã‚‹ï¼ˆY=0ã‚ˆã‚Šä¸‹ã«ã¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ãªã„ï¼‰
        if (targetTopY > 0) targetTopY = 0;

        // ç¾åœ¨ã®ã‚«ãƒ¡ãƒ©ä½ç½®
        const currentTopY = render.bounds.min.y;

        // ã‚¹ãƒ ãƒ¼ã‚ºç§»å‹•ï¼ˆä¸Šã«ç§»å‹•ã™ã‚‹ã¨ãã ã‘ï¼‰
        if (targetTopY < currentTopY) {
            // å·®åˆ†ã®5%ãšã¤ç§»å‹•
            const newY = currentTopY + (targetTopY - currentTopY) * 0.05;
            
            Render.lookAt(render, {
                min: { x: 0, y: newY },
                max: { x: w, y: newY + h }
            });
        } else if (currentTopY < 0 && !hasStack) {
            // ã‚‚ã—ãƒã‚°ã§ã‚«ãƒ¡ãƒ©ãŒä¸Šã«è¡Œãéãã¦ã„ã¦ã€ã‹ã¤ç©ã¿æœ¨ãŒãªã„ãªã‚‰æˆ»ã™
             Render.lookAt(render, { min: { x: 0, y: 0 }, max: { x: w, y: h } });
        }

        // --- ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼åˆ¤å®š ---
        // çš¿ã‚ˆã‚Šç”»é¢é«˜ã•åˆ†ãã‚‰ã„ä¸‹ã«è½ã¡ãŸã‚‰
        const deadLine = ground.position.y + h;
        allBodies.forEach(b => {
            if (b.label === 'Pintxo' && b !== currentPintxo) {
                if (b.position.y > deadLine) {
                    gameOver();
                }
            }
        });

        updateDebugInfo();
    }

    function updateDebugInfo() {
        const camY = Math.round(render.bounds.min.y);
        const groundY = Math.round(ground ? ground.position.y : 0);
        const objCount = Composite.allBodies(engine.world).length;
        document.getElementById('debug-info').innerHTML = 
            `Cam Y: ${camY} <br> Ground Y: ${groundY} <br> Objects: ${objCount}`;
    }

    // --- æ“ä½œ ---
    function move(dir) {
        if(currentPintxo && !isDropping) Body.translate(currentPintxo, {x: dir*6, y:0});
    }
    function rotate() {
        if(currentPintxo && !isDropping) Body.rotate(currentPintxo, Math.PI/4);
    }
    function drop() {
        if(currentPintxo && !isDropping) {
            isDropping = true;
            Body.setStatic(currentPintxo, false);
            currentPintxo.isDropped = true;
            
            // æ¬¡ã®ç”Ÿæˆäºˆç´„
            setTimeout(() => {
                if(gameActive) {
                    calcScore(currentPintxo);
                    spawnPintxo();
                }
            }, 2000);
        }
    }

    function calcScore(body) {
        // çš¿ã‹ã‚‰ã®é«˜ã•
        const diff = ground.position.y - body.position.y;
        if (diff > 0) {
            score += (Math.floor(diff / 10) + 10);
            document.getElementById('score-val').innerText = score;
        }
    }

    function gameOver() {
        gameActive = false;
        document.getElementById('final-score').innerText = score;
        document.getElementById('controls').classList.add('hidden');
        document.getElementById('game-over-screen').classList.remove('hidden');
        document.getElementById('input-area').classList.remove('hidden');
        document.getElementById('ranking-area').classList.add('hidden');
    }

    // --- ãƒ©ãƒ³ã‚­ãƒ³ã‚° ---
    window.saveScore = function() {
        const name = document.getElementById('player-name').value || "åç„¡ã—";
        const data = JSON.parse(localStorage.getItem('pintxosRank')) || [];
        data.push({ name: name, score: score });
        data.sort((a,b)=>b.score-a.score);
        localStorage.setItem('pintxosRank', JSON.stringify(data.slice(0,5)));
        showRank();
    };
    function showRank() {
        const data = JSON.parse(localStorage.getItem('pintxosRank')) || [];
        const list = document.getElementById('ranking-list');
        list.innerHTML = "";
        data.forEach((d,i) => {
            list.innerHTML += `<li><span>${i+1}.${d.name}</span><span>${d.score}</span></li>`;
        });
        document.getElementById('input-area').classList.add('hidden');
        document.getElementById('ranking-area').classList.remove('hidden');
    }
    window.resetGame = function() { startGame(); };

    // ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
    const btnL = document.getElementById('btn-left');
    const btnR = document.getElementById('btn-right');
    const btnRot = document.getElementById('btn-rotate');
    const btnDrop = document.getElementById('btn-drop');

    const hold = (btn, action) => {
        let t;
        const s = (e)=>{ e.preventDefault(); action(); t=setInterval(action,50); };
        const e = (e)=>{ e.preventDefault(); clearInterval(t); };
        btn.addEventListener('touchstart',s,{passive:false});
        btn.addEventListener('touchend',e);
        btn.addEventListener('mousedown',s);
        btn.addEventListener('mouseup',e);
    };
    hold(btnL, ()=>move(-1));
    hold(btnR, ()=>move(1));
    
    btnRot.addEventListener('click', rotate);
    btnRot.addEventListener('touchstart', (e)=>{e.preventDefault(); rotate()});
    
    btnDrop.addEventListener('click', drop);
    btnDrop.addEventListener('touchstart', (e)=>{e.preventDefault(); drop()});

</script>
</body>
</html>
