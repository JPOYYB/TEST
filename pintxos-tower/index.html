<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pintxos Tower</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        /* å…¨ä½“ã®ãƒªã‚»ãƒƒãƒˆ */
        body { 
            margin: 0; padding: 0; overflow: hidden; 
            background-color: #f0f0f0; 
            font-family: 'Helvetica', sans-serif; 
            touch-action: none; /* ã‚¹ãƒãƒ›ã§ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é˜²æ­¢ */
            width: 100vw; height: 100vh;
        }

        /* ã‚²ãƒ¼ãƒ ç”»é¢ï¼ˆã‚­ãƒ£ãƒ³ãƒã‚¹ï¼‰ */
        canvas { 
            display: block; 
            width: 100%; 
            height: 100%; 
        }
        
        /* UIãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆã‚¹ã‚³ã‚¢ã‚„ãƒœã‚¿ãƒ³ãªã©ï¼‰ */
        #ui-layer { 
            position: absolute; top: 0; left: 0; 
            width: 100%; height: 100%; 
            pointer-events: none; /* UIã®éš™é–“ã¯ã‚¯ãƒªãƒƒã‚¯é€é */
            z-index: 10;
        }
        
        /* ã‚¿ã‚¤ãƒˆãƒ«ãƒ»ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ç”»é¢ï¼ˆUIã®ä¸Šã«è¢«ã›ã‚‹ï¼‰ */
        #title-screen, #game-over-screen { 
            position: absolute; top: 0; left: 0; 
            width: 100%; height: 100%; 
            background: rgba(255, 255, 255, 0.95); 
            display: flex; flex-direction: column; 
            align-items: center; justify-content: center; 
            pointer-events: auto; 
            z-index: 20; 
        }

        h1 { margin: 0 0 20px 0; color: #333; font-size: 2em; text-align: center;}
        p { margin: 10px; color: #666; text-align: center;}

        /* æ±ç”¨ãƒœã‚¿ãƒ³ãƒ‡ã‚¶ã‚¤ãƒ³ */
        button.btn { 
            padding: 15px 40px; font-size: 1.2em; 
            background: #ff6b6b; color: white; 
            border: none; border-radius: 30px; 
            cursor: pointer; box-shadow: 0 4px 0 #d45050; 
            margin-top: 10px;
        }
        button.btn:active { transform: translateY(4px); box-shadow: none; }

        /* ã‚¹ã‚³ã‚¢è¡¨ç¤º */
        #score-board { 
            position: absolute; top: 20px; left: 20px;
            font-size: 1.5em; color: #333; font-weight: bold; 
            text-shadow: 2px 2px 0 #fff; 
            pointer-events: none;
        }
        
        /* æ“ä½œãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ï¼ˆç”»é¢ä¸‹éƒ¨ã«å›ºå®šï¼‰ */
        #controls { 
            position: absolute; 
            bottom: 30px; /* ä¸‹ã‹ã‚‰30px */
            left: 0; 
            width: 100%; 
            height: 100px;
            display: flex; /* Flexboxã§æ¨ªä¸¦ã³ */
            justify-content: center; /* ä¸­å¤®æƒãˆ */
            align-items: center; 
            gap: 15px; /* ãƒœã‚¿ãƒ³é–“ã®éš™é–“ */
            pointer-events: auto; 
            z-index: 15;
        }

        /* æ“ä½œãƒœã‚¿ãƒ³å€‹åˆ¥ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .control-btn { 
            width: 60px; height: 60px; 
            border-radius: 50%; border: 2px solid #ccc; 
            background: rgba(255, 255, 255, 0.9); 
            font-size: 24px; cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2); 
            touch-action: manipulation;
            display: flex; align-items: center; justify-content: center;
        }
        .control-btn:active { background: #ddd; }
        
        /* è½ä¸‹ãƒœã‚¿ãƒ³ã ã‘å¤§ããç›®ç«‹ãŸã›ã‚‹ */
        #btn-drop { 
            width: 80px; height: 80px; 
            background: #ff4757; color: white; border: none;
            font-size: 30px;
        }

        /* ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒªã‚¹ãƒˆ */
        #ranking-list { list-style: none; padding: 0; width: 80%; max-width: 300px; margin: 10px 0; }
        #ranking-list li { border-bottom: 1px solid #ccc; padding: 5px; display: flex; justify-content: space-between; }
        input#player-name { padding: 10px; font-size: 1em; border: 1px solid #ccc; border-radius: 5px; margin-bottom: 10px; width: 70%; text-align: center;}
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div id="score-board">SCORE: <span id="score-val">0</span></div>
        
        <div id="controls" class="hidden">
            <button class="control-btn" id="btn-left">â¬…ï¸</button>
            <button class="control-btn" id="btn-rotate">ğŸ”„</button>
            <button class="control-btn" id="btn-right">â¡ï¸</button>
            <button class="control-btn" id="btn-drop">â¬‡ï¸</button>
        </div>
    </div>

    <div id="title-screen">
        <h1>Pintxos Tower</h1>
        <p>ç”»åƒã‚’ç©ã¿ä¸Šã’ã¦é«˜ã•ã‚’ç«¶ãˆï¼</p>
        <button class="btn" onclick="startGame()">START GAME</button>
    </div>

    <div id="game-over-screen" class="hidden">
        <h1>GAME OVER</h1>
        <p>Score: <span id="final-score">0</span></p>
        
        <div id="input-area">
            <input type="text" id="player-name" placeholder="åå‰ã‚’å…¥åŠ›(8æ–‡å­—)" maxlength="8">
            <br>
            <button class="btn" style="padding: 10px 20px; font-size: 1em;" onclick="saveScore()">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«ç™»éŒ²</button>
            <br>
            <button class="btn" style="margin-top:10px; background:#aaa;" onclick="resetGame()">ç™»éŒ²ã›ãšã«ãƒªãƒˆãƒ©ã‚¤</button>
        </div>
        
        <div id="ranking-area" class="hidden">
            <h3>ğŸ† Top 5 Ranking</h3>
            <ul id="ranking-list"></ul>
            <button class="btn" style="margin-top:20px;" onclick="resetGame()">RETRY</button>
        </div>
    </div>

<script>
    // --- åˆæœŸè¨­å®š ---
    const Engine = Matter.Engine,
          Render = Matter.Render,
          Runner = Matter.Runner,
          Bodies = Matter.Bodies,
          Composite = Matter.Composite,
          Events = Matter.Events,
          Body = Matter.Body;

    // ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®å®šç¾©
    // â˜…é‡è¦: index.htmlã¨åŒã˜å ´æ‰€ã«ã‚ã‚‹ img ãƒ•ã‚©ãƒ«ãƒ€ã®ä¸­ã« 1.png ï½ 11.png ãŒã‚ã‚‹å‰æã§ã™
    const IMAGES = [];
    for(let i=1; i<=11; i++) IMAGES.push(`./img/${i}.png`);

    let engine, render, runner;
    let currentPintxo = null;
    let isDropping = false;
    let score = 0;
    let gameActive = false;
    let ground;

    // ç”»é¢ã‚µã‚¤ã‚ºå–å¾—
    let screenWidth = window.innerWidth;
    let screenHeight = window.innerHeight;

    function init() {
        // ã‚¨ãƒ³ã‚¸ãƒ³ä½œæˆ
        engine = Engine.create();
        
        // ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼ä½œæˆ
        // ã“ã“ã§ wireframes: false ã«ã—ãªã„ã¨ç”»åƒãŒè¡¨ç¤ºã•ã‚Œãšç·‘ã®ç·šã ã‘ã«ãªã‚Šã¾ã™
        render = Render.create({
            element: document.body, // bodyã«ç›´æ¥canvasã‚’è¿½åŠ 
            engine: engine,
            options: {
                width: screenWidth,
                height: screenHeight,
                background: '#f0f0f0', // èƒŒæ™¯è‰²
                wireframes: false,      // â˜…ã“ã“ãŒé‡è¦ï¼šç”»åƒã‚’æœ‰åŠ¹ã«ã™ã‚‹
                showAngleIndicator: false
            }
        });

        // åºŠï¼ˆçš¿ï¼‰ã®ä½œæˆ
        // ç”»é¢ä¸‹ã‹ã‚‰50pxã®ä½ç½®ã€‚å¹…ã¯ç”»é¢å¹…ã®80%ç¨‹åº¦
        ground = Bodies.rectangle(screenWidth / 2, screenHeight - 20, 300, 40, { 
            isStatic: true,
            label: 'Ground',
            render: { 
                fillStyle: '#8b4513', // èŒ¶è‰²
                strokeStyle: '#333',
                lineWidth: 2
            }
        });
        
        Composite.add(engine.world, ground);

        Render.run(render);
        runner = Runner.create();
        Runner.run(runner, engine);

        // æ›´æ–°ãƒ«ãƒ¼ãƒ—
        Events.on(engine, 'beforeUpdate', function() {
            if (!gameActive) return;

            // ã‚«ãƒ¡ãƒ©ç§»å‹•ï¼ˆä¸€ç•ªé«˜ã„ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«åˆã‚ã›ã¦è¦–ç‚¹ã‚’ä¸Šã’ã‚‹ï¼‰
            if (currentPintxo && !currentPintxo.isStatic) {
                // è½ä¸‹ä¸­ã¯ã‚«ãƒ¡ãƒ©å‹•ã‹ã•ãªã„
            } else {
                let allBodies = Composite.allBodies(engine.world);
                let highestY = ground.position.y;
                
                allBodies.forEach(b => {
                    if (b.label === 'Pintxo' && b.position.y < highestY) {
                        highestY = b.position.y;
                    }
                });

                // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã¨ãªã‚‹Yåº§æ¨™ï¼ˆä¸€ç•ªä¸Šã®ç‰©ä½“ã‹ã‚‰å°‘ã—ä½™è£•ã‚’æŒãŸã›ã‚‹ï¼‰
                const targetY = highestY - 300;
                
                // ç¾åœ¨ã®ã‚«ãƒ¡ãƒ©ã®ä¸­å¿ƒY
                const currentCenterY = render.bounds.min.y + screenHeight / 2;
                
                // ã‚‚ã—ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãŒç¾åœ¨ã®è¦–ç‚¹ã‚ˆã‚Šä¸Šãªã‚‰ã€ã‚¹ãƒ ãƒ¼ã‚ºã«ç§»å‹•
                if (targetY < render.bounds.min.y + 100) {
                     Render.lookAt(render, {
                        min: { x: 0, y: targetY - 200 },
                        max: { x: screenWidth, y: targetY - 200 + screenHeight }
                    });
                }
            }

            // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼åˆ¤å®š
            // ç”»é¢ã®ä¸‹é™ã‚’è¶…ãˆãŸã‚‰ã‚¢ã‚¦ãƒˆ
            let allBodies = Composite.allBodies(engine.world);
            // ç¾åœ¨ã®è¦–ç‚¹ã§ã®ç”»é¢ä¸‹ç«¯ï¼ˆã‚«ãƒ¡ãƒ©ç§»å‹•å¯¾å¿œï¼‰
            const viewBottom = render.bounds.max.y;

            allBodies.forEach(b => {
                // Groundã‚ˆã‚Šä¸‹ï¼ˆ+ä½™è£•ï¼‰ã«è½ã¡ãŸã‚‰
                if (b.label === 'Pintxo' && b.position.y > ground.position.y + 200) {
                    if (b !== currentPintxo || (b === currentPintxo && b.isDropped)) {
                        gameOver();
                    }
                }
            });
        });
        
        // ãƒªã‚µã‚¤ã‚ºå¯¾å¿œ
        window.addEventListener('resize', () => {
            screenWidth = window.innerWidth;
            screenHeight = window.innerHeight;
            render.canvas.width = screenWidth;
            render.canvas.height = screenHeight;
            // åºŠã®ä½ç½®ä¿®æ­£ãªã©ã¯è¤‡é›‘ã«ãªã‚‹ãŸã‚ä»Šå›ã¯ãƒªãƒ­ãƒ¼ãƒ‰æ¨å¥¨
        });
    }

    function startGame() {
        document.getElementById('title-screen').classList.add('hidden');
        document.getElementById('controls').classList.remove('hidden');
        document.getElementById('controls').style.display = 'flex'; // æ˜ç¤ºçš„ã«flexæŒ‡å®š
        document.getElementById('game-over-screen').classList.add('hidden');
        
        // ãƒªã‚»ãƒƒãƒˆå‡¦ç†
        Composite.clear(engine.world);
        Engine.clear(engine);
        Composite.add(engine.world, ground);
        
        // ã‚«ãƒ¡ãƒ©ä½ç½®ãƒªã‚»ãƒƒãƒˆ
        Render.lookAt(render, {
            min: { x: 0, y: 0 },
            max: { x: screenWidth, y: screenHeight }
        });

        score = 0;
        updateScore();
        gameActive = true;
        
        spawnPintxo();
    }

    function spawnPintxo() {
        if (!gameActive) return;

        // ç”»åƒé¸æŠ
        const imgIndex = Math.floor(Math.random() * IMAGES.length);
        const imgPath = IMAGES[imgIndex];
        
        // å‡ºç¾ä½ç½®ï¼ˆç¾åœ¨ã®ã‚«ãƒ¡ãƒ©ã®ä¸Šéƒ¨ï¼‰
        const spawnX = screenWidth / 2;
        const spawnY = render.bounds.min.y + 100;

        // ãƒ”ãƒ³ãƒãƒ§ã‚¹ç”Ÿæˆ
        currentPintxo = Bodies.circle(spawnX, spawnY, 40, { 
            label: 'Pintxo',
            restitution: 0.2, // å°‘ã—å¼¾ã‚€
            friction: 0.8,    // æ‘©æ“¦å¼·ã‚ï¼ˆæ»‘ã‚Šã«ããã™ã‚‹ï¼‰
            density: 0.005,
            render: {
                fillStyle: '#ffcc00', // ç”»åƒèª­ã¿è¾¼ã¿å¤±æ•—æ™‚ã®ä¿é™ºã®è‰²
                sprite: {
                    texture: imgPath,
                    xScale: 0.8, // 100pxã®ç”»åƒã‚’ç¸®å°èª¿æ•´
                    yScale: 0.8
                }
            }
        });

        Body.setStatic(currentPintxo, true); // æ“ä½œä¸­ã¯é™æ­¢
        currentPintxo.isDropped = false;

        Composite.add(engine.world, currentPintxo);
        isDropping = false;
    }

    // --- æ“ä½œãƒ­ã‚¸ãƒƒã‚¯ ---
    function moveLeft() {
        if (currentPintxo && !isDropping) {
            Body.translate(currentPintxo, { x: -5, y: 0 }); // ç§»å‹•é‡ã‚’å¾®èª¿æ•´
        }
    }
    function moveRight() {
        if (currentPintxo && !isDropping) {
            Body.translate(currentPintxo, { x: 5, y: 0 });
        }
    }
    function rotatePintxo() {
        if (currentPintxo && !isDropping) {
            Body.rotate(currentPintxo, Math.PI / 4);
        }
    }
    function dropPintxo() {
        if (currentPintxo && !isDropping) {
            isDropping = true;
            Body.setStatic(currentPintxo, false);
            currentPintxo.isDropped = true;

            // æ¬¡ã®ç”Ÿæˆ
            setTimeout(() => {
                if(gameActive) {
                    // é™æ­¢åˆ¤å®šã‚’å³å¯†ã«ã™ã‚‹ã®ã¯é›£ã—ã„ãŸã‚ã€æ™‚é–“å·®ã§æ¬¡ã‚’å‡ºã™
                    addScore(currentPintxo);
                    spawnPintxo();
                }
            }, 2500); 
        }
    }

    // --- ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆã®ç™»éŒ²ï¼ˆã‚¹ãƒãƒ›ãƒ»PCä¸¡å¯¾å¿œï¼‰ ---
    const btnLeft = document.getElementById('btn-left');
    const btnRight = document.getElementById('btn-right');
    const btnRotate = document.getElementById('btn-rotate');
    const btnDrop = document.getElementById('btn-drop');

    // é•·æŠ¼ã—å¯¾å¿œé–¢æ•°
    const addHoldEvent = (btn, action) => {
        let interval;
        const start = (e) => { 
            e.preventDefault(); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œï¼ˆé¸æŠãªã©ï¼‰ã‚’é˜²ã
            action(); 
            interval = setInterval(action, 50); // é€£ç¶šå‹•ä½œã®é–“éš”
        };
        const end = (e) => { 
            e.preventDefault(); 
            clearInterval(interval); 
        };
        
        btn.addEventListener('mousedown', start);
        btn.addEventListener('touchstart', start, {passive: false});
        btn.addEventListener('mouseup', end);
        btn.addEventListener('touchend', end, {passive: false});
        btn.addEventListener('mouseleave', end);
    };

    addHoldEvent(btnLeft, moveLeft);
    addHoldEvent(btnRight, moveRight);
    
    // å˜æŠ¼ã—ãƒœã‚¿ãƒ³
    const addClickEvent = (btn, action) => {
        btn.addEventListener('click', action);
        btn.addEventListener('touchstart', (e)=>{
            e.preventDefault(); // 2é‡ç™ºç«é˜²æ­¢
            action();
        }, {passive: false});
    }

    addClickEvent(btnRotate, rotatePintxo);
    addClickEvent(btnDrop, dropPintxo);


    // --- ã‚¹ã‚³ã‚¢ç®¡ç† ---
    function addScore(body) {
        // åœŸå°ã‹ã‚‰ã®é«˜ã•ã§ãƒã‚¤ãƒ³ãƒˆ
        const heightDiff = (ground.position.y - body.position.y);
        const point = Math.max(10, Math.floor(heightDiff / 5)); // æœ€ä½10ç‚¹
        score += point;
        updateScore();
    }

    function updateScore() {
        document.getElementById('score-val').innerText = score;
    }

    // --- ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ ---
    function gameOver() {
        if (!gameActive) return;
        gameActive = false;
        
        document.getElementById('final-score').innerText = score;
        document.getElementById('controls').classList.add('hidden'); // ãƒœã‚¿ãƒ³éš ã™
        document.getElementById('game-over-screen').classList.remove('hidden');
        document.getElementById('input-area').classList.remove('hidden');
        document.getElementById('ranking-area').classList.add('hidden');
    }

    function resetGame() {
        startGame();
    }

    // --- ãƒ©ãƒ³ã‚­ãƒ³ã‚°ä¿å­˜ ---
    function saveScore() {
        const nameInput = document.getElementById('player-name');
        const name = nameInput.value.trim() || "åç„¡ã—";
        
        const newRecord = { name: name, score: score, date: new Date().toLocaleDateString() };
        
        let rankings = JSON.parse(localStorage.getItem('pintxosRanking')) || [];
        rankings.push(newRecord);
        rankings.sort((a, b) => b.score - a.score);
        rankings = rankings.slice(0, 5); 
        
        localStorage.setItem('pintxosRanking', JSON.stringify(rankings));
        
        showRanking();
    }

    function showRanking() {
        document.getElementById('input-area').classList.add('hidden');
        document.getElementById('ranking-area').classList.remove('hidden');
        
        const list = document.getElementById('ranking-list');
        list.innerHTML = "";
        
        const rankings = JSON.parse(localStorage.getItem('pintxosRanking')) || [];
        rankings.forEach((r, idx) => {
            const li = document.createElement('li');
            li.innerHTML = `<span>${idx+1}. ${r.name}</span> <span>${r.score}pt</span>`;
            list.appendChild(li);
        });
    }

    // åˆæœŸåŒ–
    window.onload = init;

</script>
</body>
</html>
